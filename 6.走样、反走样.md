
# 采样
## 概念
### 采样 Sample
采样时一种思想，把一个连续的函数给离散化的过程。采样的形式很多，例如视频采样：视频是离散的一帧一帧，人眼实际上也是采样的

### 走样 Alising
由于采样频率过慢，导致信号中的高频成分“混叠”或“伪装”成低频成分，从而造成信号失真的现象
**Artifacts 瑕疵**：一切的不准确、错误，这是个图形学上的概念

## 采样产生的问题
1. 锯齿
2. 摩尔纹
3. 车轮效应
造成问题的原因：采样频率低。专业说法为：信号 signals 变化的太快（高频，high frequency）而我们采样太慢

要解决问题就要使用反走样方法：
- 先进行一次模糊操作（滤波）再进行采样（注意：先采样再滤波是不行的）
- 先模糊的目的，就是在采样前主动移除掉那些会引起走样的高频信号。如果先采样，高频信息已经“污染”了数据（即已经发生了走样），此时再模糊就为时已晚，无法恢复原始信号了

# 信号处理初步
## 频域和时域
### 时域 
这是我们最直观的观点。描述的是信号的幅度（或振幅）如何随时间变化。时域图的横轴是时间，纵轴是信号的幅度，你可以通过它看出信号在哪个时间点有多强
### 频域
描述的是信号由哪些**不同频率的成分**组成。频域图的横轴是**频率**，纵轴是该频率成分的**强度**（或幅度）。你可以通过它看出信号主要是由哪些频率的**正弦波**构成的，以及各个频率成分的“能量”占比。
![[Drawing 2025-08-02 02.36.19.excalidraw]]

## 傅里叶变换
傅里叶变换是在时域和频域之间切换的数学桥梁
核心思想：任何复杂的信号（无论其时域波形多么不规则），都可以被看作是许多个不同频率、不同振幅的简单正弦波的叠加
### 从傅里叶级数到傅里叶变换
首先需要明确傅里叶级数与傅里叶变换之间的区别与关系：
- 傅里叶级数用于将一个**周期函数**表示为无穷多个正弦和余弦函数的叠加
- 傅里叶变换用于将一个**非周期函数从时域转换成频域**，表示为连续的频谱
- 当我们考虑一个周期 T 趋于无穷大的周期函数（即周期无限增大，函数变为非周期函数），傅里叶级数中的频谱线间隔（频率间隔）趋于零，离散的频谱逐渐变为连续的频谱分布。这时，傅里叶级数过渡为傅里叶变换

#### 傅里叶级数推导
在满足**狄利克雷条件**下任何周期函数都能近似分解（展开）为傅里叶级数，傅里叶级数是一种特殊的三角级数

##### 狄利克雷条件 :
- 在一周期内连续或只有有限个第一类间断点
- 在一周期内至多只有有限个（真正的）极值点
- 在一周期内，信号是绝对可积的
补充：
- （真正的）极值点:端点不算，不可导也不算（间断或尖点）
-  绝对可积：函数的绝对值在区间上（一个周期）的积分是有限的
- 为什么要求这些条件：
	- 重点在于确保傅里叶系数的积分是收敛的
	- 计算傅里叶系数时需要对函数f(x)与正弦或余弦函数的乘积进行积分。如果f(x)在一周期内不是绝对可积的，那么这些积分可能发散，导致系数不存在或无意义。而如果绝对可积，由于三角函数时有界的，故这些积分收敛。

在实际工程上往往不需要对具体信号进行严格分析，默认是满足傅里叶展开的，即使不满足也会有一定的鲁棒性

##### 三角级数
简谐振动是最简单的周期现象，可以用 $y=A\sin(wt+\varphi)$ 表示
其中A为振幅，$\varphi$ 为初相角， $w$ 为角频率，周期 $T=\frac{2\pi}{w}$

复杂的周期运动可以用n个简谐振动的叠加表示：
$$
y=\sum^n_{k=1}y_{k}=\sum^n_{k=1}A_{k}\sin(kwt+\varphi_{k})
$$
对无穷个简谐运动进行叠加，就得到函数项级数
$$
f(t)=A_{0}+\sum^\infty_{n=1}A_{n}\sin(nwt+\varphi_{n})=A_{0}+\sum^\infty_{n=1}(A_{n}\sin \varphi_{n}\cos nx+A_{n}\cos \varphi_{n}\sin nx)
$$
其中 $A_{0}$ 可以理解为信号中的直流分量
若该级数收敛，则可以用来表示更一般的周期运动现象。（该级数并不必然收敛，收敛条件为 $\sum^\infty_{n=1}(a_{n}\cos nx+b_{n}\sin nx)$ 收敛）

为了方便后面计算，转换一下形式
$$
f(x)=\frac{a_{0}}{2}+\sum^\infty_{n=1}(a_{n}\cos nx+b_{n}\sin nx)
$$
其中 $\frac{a_{0}}{2}=A_{0},a_{n}=A_{n}\sin\varphi_{n},b_{n}=A_{n}\cos \varphi_{n}$
有这种形式的函数项级数为三角级数，傅里叶级数是三角级数

可以看出三角技术依赖于三角函数系 $(1,\cos x,\sin x,\dots,\cos nx,\sin nx)$，这些周期为 $2\pi$ 的三角函数，所以下面我们需要一点三角函数的性质
###### 三角函数的正交性
频率不同的三角函数相乘在同一个周期内 $-\pi,\pi$ 的积分必为 0，即
$$
\begin{align}
\int^\pi_{-\pi}\cos(nx)\cos(mx)dx&=0 \\
\int^\pi_{-\pi}\sin(nx)\cos(mx)dx&=0 \\
\int^\pi_{-\pi}\sin(nx)\sin(mx)dx&=0,(n\neq m)
\end{align}
$$
证明：
由于三角形的周期性，易得：
$$
\begin{align}
\int^\pi_{-\pi}\sin(nx)dx=0 \\
\int^\pi_{-\pi}\cos(nx)dx=0
\end{align}
$$
下面对 $\int^\pi_{-\pi}\sin (nx)\sin (mx)dx$ 的情况进行证明，其他证明同理
利用三角形和差化积公式得：
$$
\int^\pi_{-\pi}\sin (nx)\sin (mx)dx=\frac{1}{2}\int^\pi_{-\pi}\cos[(n-m)x]-\cos[(n+m)x]dx=0
$$
由此可以延伸出在任意长为 $2\pi$ 的区间内三角函数保持正交性

而且当 $n=m$ 时
$$
\begin{align}
\int^\pi_{-\pi}\cos(nx)\cos(nx)dx&=\pi \\
\int^\pi_{-\pi}\sin(nx)\sin(nx)dx&=\pi \\
\int^\pi_{-\pi}\sin(nx)\cos(nx)dx&=0
\end{align}
$$

##### 傅里叶级数的确定
首先确定 $a_{n}、b_{n}$ 的表达式，先从周期为 $2\pi$ 的函数开始讨论。假定周期函数 $f(x)$ 能展开乘三角级数：
$$
f(x)=\frac{a_{0}}{2}+\sum^\infty_{n=1}(a_{n}\cos nx+b_{n}\sin nx)
$$
对等号两边积分得到：
$$
\int_{-\pi}^\pi f(x)dx=\int^\pi_{-\pi}\frac{a_{0}}{2}dx+\sum^\infty_{n=1}\int^\pi_{-\pi}(a_{n}\cos nx+b_{n}\sin nx)dx=\pi a_{0}
$$
所以 $a_{0}=\frac{1}{\pi}\int^\pi_{-\pi}f(x)dx$

对等号两边同时乘以 $\cos(mx)$，并积分：
$$
\int^\pi_{-\pi}f(x)\cos(mx)dx=\int^\pi_{-\pi}\frac{a_{0}}{2}\cos(mx)dx+\sum^\infty_{m=1}\int(a_{n}\cos (nx)\cos (mx)+b_{n}\sin (nx)\cos(mx))dx
$$
由于三角形的正交性：$\sum^\infty_{n=1}\int^\pi_{-\pi}(a_{n}\cos(nx)\cos(mx)+b_{n}\sin (nx)\cos(mx))$ 只有在 $n=m$ 时才会留下东西，即
$$
\int^\pi_{-\pi}f(x) \cos(mx)dx=\int^\pi_{-\pi}a_{n}\cos(mx)\cos(mx)dx=\pi a_{m}
$$
即得：
$$
\begin{align}
a_{n}&=\frac{1}{\pi}\int^\pi_{-\pi}f(x)\cos(nx)dx \text{,同理得}\\
b_{n}&=\frac{1}{\pi}\int^\pi_{-\pi}f(x)\sin(nx)dx
\end{align}
$$
（由于正交性导致 a 对应 cos，b 对应 sin）

由此得到了以 $2\pi$ 为周期的傅里叶级数展开公式
$$
\begin{align}
a_{n}&=\frac{1}{\pi}\int^\pi_{-\pi}f(x)\cos(nx)dx\\
b_{n}&=\frac{1}{\pi}\int^\pi_{-\pi}f(x)\sin(nx)dx \\
 \\
f(x)&\sim\frac{a_{0}}{2}+\sum^\infty_{n=1}(a_{n}\cos nx+b_{n}\sin nx)
\end{align}
$$
**延展到以 $2l$ 为**：
周期 $[-l,l]$ 的表达式：
$$
\begin{align}
a_{n}&=\frac{1}{l}\int^l_{-l}f(x)\cos\left( \frac{n\pi x}{l} \right)dx\\
b_{n}&=\frac{1}{l}\int^l_{-l}f(x)\sin\left( \frac{n\pi x}{l} \right)dx \\
 \\
f(x)&\sim\frac{a_{0}}{2}+\sum^\infty_{n=1}(a_{n}\cos \frac{n\pi x}{l}+b_{n}\sin \frac{n\pi x}{l})
\end{align}
$$
周期 $[0,2l]$ 的表达式：
$$
\begin{align}
a_{n}&=\frac{1}{l}\int^{2l}_{0}f(x)\cos\left( \frac{n\pi x}{l} \right)dx\\
b_{n}&=\frac{1}{l}\int^{2l}_{0}f(x)\sin\left( \frac{n\pi x}{l} \right)dx \\
 \\
f(x)&\sim\frac{a_{0}}{2}+\sum^\infty_{n=1}(a_{n}\cos \frac{n\pi x}{l}+b_{n}\sin \frac{n\pi x}{l})
\end{align}
$$

同时我们可以得知傅里叶级数**与波幅相位之间的关系**
$$
\begin{align}
A_{n}&=\sqrt{ a_{n}^2+b_{n}^2 } \\
\varphi_{n}&=\arctan\left(\frac{b_{n}}{a_{n}}\right)
\end{align}
$$

###### 复指数形式的傅里叶级数
通过欧拉公式 $e^{i\theta}=\cos \theta+i\sin \theta$，将实数形式的周期为 $2\pi$ 的傅里叶级数转换为复指数形式：
$$
\begin{align}
f(x)&\sim \frac{a_{0}}{2}+\sum^\infty_{n=1}(a_{n}\cos nx+b_{n}\sin nx) \\
&=\frac{a_{0}}{2}+\sum^\infty_{n=1}\left( a_{n}\frac{e^{inx}+e^{-inx}}{2}+b_{n}\frac{e^{inx}-e^{-inx}}{2i} \right) \\
&=\frac{a_{0}}{2}+\sum^\infty_{n=1}\left[\left( \frac{a_{n}}{2}+\frac{b_{n}}{2i} \right)e^{inx}+\left( \frac{a_{n}}{2}-\frac{b_{n}}{2i} \right)e^{-inx}\right] \\
&=\sum^\infty_{-\infty}c_{n}e^{inx}
\end{align}
$$
其中 $n>0,c_{n}=\frac{1}{2}(a_{n}-ib_{n}),c_{-n}=\frac{1}{2}(a_{n}+ib_{n})$

这里引入了**复频率**的概念，傅里叶变换处理的是复频率中 $sigma=0$ 的特殊情况，而更通用的**拉普拉斯变换**则是在整个复频率平面 $s = \sigma + iω$ 上进行分析的

拓展到周期为 $T$ 的周期函数：
$$
\begin{align}
f(t)&\sim \sum^{+\infty}_{n=-\infty}c_{n}e^inwt \\
w&=\frac{2\pi}{T}c_{n}=\frac{1}{T}\int_{T}f(t)e^{-inwt}dt
\end{align}
$$
##### 傅里叶变换推导
为了推广至非周期的函数，我们将 $T\to \infty$ 进行思考

当 $T\to \infty$ 时，基本频率间隔 $w=\frac{2\pi}{T}\to_{0}$，频率nw**从离散值变为连续值**
因此我们引入连续的频率变量：
$$
k=nw=n\frac{2\pi}{T}
$$
由于n是离散的，则有
$$
\Delta k=(n+1)w-nw=w=\frac{2\pi}{T}\to {0}
$$
依此将求和转换为积分：
$$
\sum^{+\infty}_{n=-\infty}c_{n}e^{inwt}=\sum^{+\infty}_{n=-\infty}c_{n}e^{ikt}=\sum^{+\infty}_{n=-\infty}c_{n}\Delta k\frac{e^{ikt}}{\Delta k}\to \int^{+\infty}_{-\infty}\frac{c_{n}}{\Delta k}e^{ikt}dk
$$
注意为什么能变为积分：由于 $\Delta k$ 很小，所以这个离散求和可以看成连续变量积分，将 $\Delta k$ 拉出来得到了这个积分

所以我们需要处理的是 $\int^{+\infty}_{-\infty}\frac{c_{n}}{\Delta k}e^{ikt}dk$

下面探究 $\lim_{ \Delta k \to 0 }\frac{c_{n}}{\Delta k}$：
由于 $C_{n}=\frac{1}{T}\int_{T}f(t)e^{-inwt}dt=\frac{1}{T}\int_{T}f(t)e^{-ikt}dt=\frac{1}{T}F(k)$ (T与k相联系，所以f(t)通过积分受到k控制)，且 $\Delta k=\frac{2π}{T}$，则 $\frac{c_{n}}{\Delta k}=\frac{1}{T}\frac{F(k)}{\Delta k}=\frac{1}{2\pi}F(k)$	
代入积分式得：
$$
\begin{align}
f(t)=\frac{1}{2\pi}\int^{+\infty}_{-\infty}F(k)e^{ikt}dk \\
F(k)=\int^{+\infty}_{-\infty}f(t)e^{-ikt}dt
\end{align}
$$
注意这里的F(k)的表达是由于 $T\to \infty$

这就是傅里叶变换的最终形式了，总结得：
【1】傅里叶变换：将时间域上无周期的函数f(t)进行傅里叶分解得到使用连续的、无穷多个频率所表达的频率域上的函数
$$
F(k)=\int^{+\infty}_{-\infty}f(t)e^{-ikt}dt
$$
【2】傅里叶逆变换：将F(k)还原为f(t)
$$
f(t)=\frac{1}{2\pi}\int^{+\infty}_{-\infty}F(k)e^{ikt}dk
$$


傅里叶变换的目的：将函数分解为频率从低到高的三角函数，在图形学中可以看成是**从时域（空间域）变成频域**

# 空间域、频域、滤波
## 空间域、时域
**时域 (Time Domain)**：这个术语通常用于描述信号随**时间**变化的领域，例如音频信号

**空间域 (Spatial Domain)**： 在图形学中，我们处理的通常是图像。图像信号的变量是**空间位置**（即像素的 x, y 坐标），而不是时间

在图形学和信号处理中，两者的数学原理高度相通，因此常常可以互换使用术语。下文为了习惯，有时也会用“时域”来指代空间域

## 频域
我们通过**傅里叶变换 (Fourier Transform)** 将图像从空间域转换到频域。变换后的结果通常是一张频谱图，图的中心代表低频，离中心越远代表频率越高。
在频率域中：
- **低频部分**代表了图像中大面积、平缓变化的区域（如天空、墙壁）。
- **高频部分**代表了图像中变化剧烈、细节丰富的区域（如物体的边缘、精细的纹理）

值得注意的是，由于误差的原因，我们基本上无法得到真正的“频域”


![[6.走样、反走样-1754731778323.png]]
左：原图（空间域），右：频谱图（频域）。注意中心区域的亮点，代表这张图有大量的低频信息
## 滤波
滤波的本质，就是在**频域**中选择性地**保留或抑制**某些频率的信号，从而达到有规律的、整体的修改图像的目的

高通滤波：**只显示高频信号所增加的细节**
低通滤波、中通滤波同理

## 采杨和欠采样
![[6.走样、反走样-1754731889756.png]]
在相同采样频率下, 越高频的信息丢失越多，从而我们根据采样所恢复的信息的偏差越大，两个相差巨大的函数可能会有相同的采样，这就是摩尔纹的由来，这就是走样的本质
![[6.走样、反走样-1754731910185.png]]


## 卷积
**核心思想**: 卷积是一种数学运算，通过将一个函数（**卷积核**/滤波器）在另一个函数（信号/图像）上“滑动”并计算每一点的加权平均，从而提取或修改原始信号的特征

## 连续定义
两个函数 $f$ 和 $g$ 的卷积写作 $(f*g)(t)$，$t$ 在图形学中是空间或时间变量
$$
(f*g)(t)=\int^{+\infty}_{-\infty}f(\tau)g(t-\tau)d\tau
$$
- $\tau$ 是积分变量，可以看成是在时间轴上滑动的位置
- 可以看作是将函数 g **翻转并平移**，然后计算它与函数 f 在每个位置的重叠面积
- 卷积积分实际上是在计算两个函数的重叠程度

## 离散定义
在图形学中处理像素时，我们使用离散卷积。一个像素的新值由其自身及邻域像素与一个卷积核的加权和决定。具体操作如下：
![[6.走样、反走样-1754731925914.png]]
这里可以看作原本的图片（上）是时域，对应着有无限高频率信息的频域（下），对其进行卷积操作（下）得到频域，相当于上方图片对于周围九个像素求平均（3 x 3 均值滤波器），即对应的频域要根据于周围九个像素求平均所对应的频域再采样一次得到新的频域再套用回时域，得到新的时域

相当于进行了一次滤波，只显示特定的频率信息。也相当于完成了一次模糊操作。实际上，模糊就是再频域上对图片进行低通滤波，去除了高频的信号，这也是反走样技术的关键所在，即去除高频信号

其他常用的卷积核有：
- **图像模糊 (Image Blurring)**
    - **均值模糊 (Box Blur)**: 最简单的模糊。它的卷积核所有权重都相等。这相当于对一个像素邻域内的所有像素取平均值，效果生硬但计算快
$$
K_{box}=\frac{1}{9}\left[\begin{matrix}
1&1&1 \\
1&1&1 \\
1&1&1
\end{matrix}\right]
$$
    - **高斯模糊 (Gaussian Blur)**: 最常用的模糊。**核内权重呈高斯分布**，中心权重最高，向外围逐渐衰减。这更符合光学中的点扩散效应，能产生非常平滑、自然的模糊效果。常用于**景深 (Depth of Field)**、**泛光 (Bloom)** 等特效
$$
K_{gaussian}=\frac{1}{4}\left[\begin{matrix}
1&2&1 \\
2&4&2 \\
1&2&1
\end{matrix}\right]
$$
- **图像锐化 (Sharpening)**
    - 锐化是模糊的反操作。它通过增强像素与其邻域的差异来让图像看起来更清晰。其卷积核的特点是中心权重为正，周围权重为负
$$
K_{sharpen​}=\left[\begin{matrix}
0&-1&0 \\
-1&5&-1 \\
0&-1&0
\end{matrix}\right]
$$
- **边缘检测 (Edge Detection)**
    - 通过卷积可以检测出图像中的边缘。**Sobel算子**是经典方法之一，它使用两个卷积核，分别检测水平和垂直方向的亮度变化率（梯度）。这是计算机视觉和图像分析（如轮廓渲染）的基础
$$
G_{x}=\left[\begin{matrix}
-1&0&1 \\
-2&0&2 \\
-1&0&1
\end{matrix}\right],G_{y}=\left[\begin{matrix}
-1&-2&-1 \\
0&0&0 \\
1&2&1
\end{matrix}\right]
$$

## 关键定理
### 时域的卷积等于频域的乘积
数学表达：
$$
FFT(f*g)=FFT(f)\cdot FFT(g)
$$
- $*$ 代表卷积，$\cdot$ 代表逐点乘法，FFT 是傅里叶变换

**左边 `f * g`**: 这里的星号 `*` 指的是对函数 `f` 和 `g` 进行**卷积**操作。这是一个积分运算，涉及到其中一个函数的翻转和平移，计算的是两个函数在每个位置的“重叠面积”

**右边 `FFT(f) · FFT(g)`**: 这里的 `·` 指的是**逐点乘法**。`FFT(f)` 和 `FFT(g)` 都是频域中的新函数。这个运算非常简单，对于每一个频率点 `ω`，就是将两个函数在该点的值直接相乘

这个公式告诉我们，在时域（或空间域）中进行复杂、耗时的**卷积**运算，其效果等同于在频域中进行简单、快速的**逐点乘法**
### 时域的乘积等于频域的卷积
数学表达：
$$
FFT(f\cdot g)=FFT(f)*FFT(g)
$$

**左边 `f · g`**: 这里的 `·` 同样指的是**逐点乘法**。它描述的是两个函数 `f` 和 `g` 在时域中的直接相乘

**右边 `FFT(f) * FFT(g)`**: 这里的星号 `*` 指的是在**频域**中对两个频谱 `FFT(f)` 和 `FFT(g)` 进行**卷积**操作

这个公式告诉我们，在时域中进行简单的**逐点乘法**（例如，用脉冲函数进行采样），其效果等同于在频域中进行复杂的**卷积**（即将原始频谱进行复制和移动）
![[image-1-4 3.png]]
# 反走样方法
为什么会产生走样现象：
![[6.走样、反走样-1754731954107.png]]
由于采样率不够导致高频部分的信号出现差错，这就是频率意义上的走样
		
解决这个问题的最好办法自然是增加采样率，但是会增加代价（烧钱）
		
那么我们可以自然的想到，如果再采样前进行适当的模糊（去除高频信号），自然可以在一定程度上解决频谱混叠的问题，从而实现反走样
![[6.走样、反走样-1754731968073.png]]
具体来说：如何对一个三角形进行模糊操作
	对三角形图形应用低通滤波器：如 3 x 3 低通滤波器
	则对于每个像素，其等于在附近 3 x 3 区域内所有像素颜色的平均值

## MSAA
采用更多的采样点进行反走样，将一个像素划分为更多的小像素，通过对小像素进行采样并取其平均值来确定像素的值

注意: MSAA 增加了采样率但没有增加分辨率
