# 无偏（Unbiased）光线传播算法
在蒙特卡洛渲染中，**无偏**指的是一种算法的**期望值**（当样本数量趋于无穷时）会精确收敛到物理上正确的结果（像概率论与数理统计中的一样）。这类算法的唯一误差是噪点（方差），它会随着样本数量的增加而减少
## 双向路径追踪
![[13.高级渲染技术-1755660699850.png]]
标准路径追踪（即使经过直接光照采样优化）在某些光路复杂的情况下，收敛速度会非常慢，产生大量噪点。其中最经典的“老大难”问题就是**焦散 (Caustics)**
- **焦散 (Caustics)**: 光线通过一个光滑的镜面或折射表面（如玻璃、水面）反射或折射后，汇聚并照亮一个漫反射表面的现象。例如，阳光穿过一个玻璃杯，在桌面上形成一个明亮的聚焦光斑
**为什么路径追踪难以处理焦散？** 标准的路径追踪是从相机发出光线。为了渲染出焦散效果，这条光线必须：
1. 从相机出发，精确地击中桌面上的那个**漫反射**光斑
2. 然后从那个点以一个**非常刁钻的角度**弹射出去，恰好能穿过那个小小的玻璃杯
3. 穿过玻璃杯后发生折射，然后又必须以一个**同样刁钻的角度**，在广阔的天空中精确地击中那个面积很小的太阳光源
这一连串事件同时发生的概率极低，导致绝大多数路径都无法采样到这条光路，最终图像上可能只有零星的几个像素算出了极高的亮度，而大部分区域则是黑的

双向路径追踪通过一个非常聪明的策略来解决这个问题：**同时从相机和光源两个方向追踪路径，然后在中间将它们连接起来**

![[13.高级光线传播-1755663573562.png]]

算法会同时生成两种路径：
1. **相机路径 (Eye Path)**: 和标准路径追踪一样，从相机发出光线，在场景中弹射 `k` 次。这条路径上的所有顶点（弹射点）都被记录下来
2. **光源路径 (Light Path)**: **同时**，从光源上随机一点出发，向场景中发射光线，并在场景中弹射 `m` 次。这条路径上的所有顶点也被记录下来
上图展示了双向路径追踪中，一条长度为2的相机路径和一条长度为1的光源路径，通过连接中间点形成了一条完整的路径

### 路径连接 (Path Connecting)
在分别生成了一条相机路径和一条光源路径后，算法会尝试将**相机路径上的每一个顶点**与**光源路径上的每一个顶点**进行连接：
- 从相机路径的第 `i` 个顶点 $y_i$，向光源路径的第 `j` 个顶点 $z_j$ 发射一条**阴影光线**
- 如果这条光线**没有被任何物体遮挡**，那么我们就成功地构建出了一条从光源到相机的完整光路
- 算法会计算这条新构建的路径的**能量贡献**（需要考虑两个连接点的BRDF以及它们之间的几何衰减项）
### 贡献的加权与组合
一条完整的光路可以由多种方式构成（例如，一条长度为5的路径，可以是5次相机弹射，也可以是2次相机弹射+2次光源弹射+1次连接）

为了避免重复计算并获得最优的（噪点最低的）结果，双向路径追踪使用一种名为**多重重要性采样 (Multiple Importance Sampling, MIS)** 的技术。MIS会根据每种连接策略（包括纯相机路径和纯光源路径）采到这条完整光路的概率，来为不同策略产生的贡献进行智能加权

### 优缺点
- **优点**:
    - **极其擅长处理复杂光路**: 对于焦散、光线透过门缝照亮室内等场景，BDPT的收敛速度和效果远超单向路径追踪
    - **更稳健 (Robust)**: 算法的适用性更广，对于各种棘手的间接光照场景都能给出比较好的结果
- **缺点**:
    - **实现复杂**: 算法的逻辑比单向路径追踪复杂得多，需要存储两条路径并进行大量的连接尝试
    - **性能开销高**: 每一条路径的计算成本更高，并且存储光源路径需要更多的内存
    - **不一定总是更快**: 在一些简单的、直接光照为主的开放场景中，由于其额外的开销，它的效率可能反而不如经过优化的单向路径追踪
## Metroplis 光线传播（MLT）
MLT是一种更为先进的无偏渲染算法，它借鉴了统计物理学中的思想，用于解决一些连BDPT都难以处理的极端复杂光路问题（例如光线通过门缝再经过多次复杂反射和折射照亮一个场景）
- **核心思想**: 标准路径追踪（包括BDPT）的每次采样（每条路径）都是完全**独立**的。而MLT则不同，它会生成一条**相关的采样链**。算法首先找到一条**有效**的光路，然后通过对这条路径进行微小的、随机的**“突变” (Mutation)**（例如，稍微移动路径上的一个顶点，或改变一次反射方向），来探索其周围的相似路径。
- **智能探索**: MLT使用一种接受/拒绝策略（Metropolis-Hastings算法）来决定是否采纳这个“突变”后的新路径。贡献大的（更“重要”的）新路径更容易被接受。这种机制使得采样过程能**集中在场景中对图像贡献最大的光路上**，并对其进行更深入、更高效的探索。
- **优缺点**:
    - **优点**: 在处理极其困难的“间接光照为主”的场景和复杂焦散时，效果无与伦比
    - **缺点**: 算法非常复杂，且样本之间具有相关性，导致噪点呈现出独特的“斑点状”，收敛状态难以判断
# 有偏（Biased）光线传播
“有偏”算法为了大幅**提升渲染速度**或**降低噪点**，会有意地引入一些系统性的、微小的误差或近似。这意味着即使样本数无穷，其结果也不会收敛到物理上完全精确的解，但通常能更快地得到一个视觉上可接受的、干净的图像
## 光子映射 Photon Mapping
![[13.高级光线传播-1755664985425.png]]
光子映射的方法很多，介绍较为经典的一种
![[13.高级光线传播-1755665230696.png]]
1. **光子追迹 (Photon Tracing)**
    - 从光源向场景中发射大量“光子”（携带能量的粒子）
    - 光子在场景中弹射，当它们击中**非镜面**（漫反射或次表面散射）时，它们的位置、能量和方向等信息会被存储在一个名为**光子图 (Photon Map)** 的空间数据结构中（通常是KD-Tree）
![[13.高级光线传播-1755665250132.png]]
2. **最终收集 (Final Gathering)**
    - 从相机向场景中发射光线（类似路径追踪）。
    - 当光线击中一个漫反射表面时，它**不再继续随机弹射**，而是在交点周围的一个小半径范围内**查找光子图**
    - 通过统计这个范围内光子的密度和能量，来快速**估算**该点的间接光照和焦散
- **优缺点**:
    - **优点**: 渲染焦散效果又快又好
    - **缺点**: 结果是有偏的（最终着色依赖于**查找半径**，会产生模糊），需要大量内存存储光子，且参数（光子数量、查找半径）难以调整
## VCM (Vertex Connection and Merging)
实现很复杂，但是思想很简单：**将双向路径追踪 (BDPT) 和光子映射 (Photon Mapping) 的优点结合在了一起**。它通过多种策略来连接光路
![[13.高级光线传播-1755665473181.png]]
- 连接相机路径和光源路径的顶点（BDPT的核心）
- 连接相机路径的顶点和光子图中的光子（光子映射的核心）
- **顶点合并 (Vertex Merging)**: 当相机路径的顶点和光源路径的顶点**非常接近**时，将它们“**合并**”，这在渲染光滑表面上的焦散时非常有效
VCM非常稳健，能够高效地处理各种复杂的全局光照场景，是现代离线渲染器中的重要技术之一

## 实时辐射度 IR
![[13.高级光线传播-1755665766216.png]]
**核心思想**: 辐射度算法将场景中的所有表面分解为一系列小块（都被视为光源，无论发不发光），然后计算这些小块之间相互照亮的程度，最终解出一个描述每个小块最终亮度的稳定状态（使用数值计算中的迭代法）。它的核心优势在于，这个计算过程是**与视点无关 (View-independent)** 的
**关键限制**: 传统辐射度算法**只能处理完美的漫反射表面**，无法模拟镜面反射、高光等现象

纯粹的辐射度算法如今已不多见，但它的思想在电子游戏等实时应用中以**光照烘焙 (Light Baking)** 的形式得以延续
# 高级外观建模
## 非表面模型
### 散射介质(参与介质)
之前的讨论大多集中在光线与**物体表面**的交互上。然而，在现实世界中，光线穿过的空间并非总是真空，它常常充满了各种微小粒子，例如**雾、烟、云、水、皮肤**等。这些充满了悬浮粒子的空间，就是**参与介质**（散射介质）
![[13.高级光线传播-1755666582403.png]]
光线在这些介质中传播时，其路径和能量会不断发生改变。在介质中的任意一点，光线都可能经历以下四种基本交互：
1. **吸收 (Absorption)**: 光线的能量被介质中的粒子吸收并转化为其他形式（如热能），导致光线强度衰减
2. **自发光 (Emission)**: 介质本身发光，例如火焰或发光的等离子体，这会增加光路的能量
3. **外散射 (Out-scattering)**: 光线与介质中的粒子碰撞后，向**其他方向**散射开，导致原路径上的光线能量减少
4. **内散射 (In-scattering)**: 从**其他方向**来的光线，在这一点发生散射后，进入了当前光路的方向，这会增加当前光路上的能量
![[13.高级光线传播-1755757657311.png]]
**相位函数**：当发生散射时，光线具体会朝哪个方向弹射，是由**相位函数**来描述的。它扮演着类似于表面BRDF的角色，决定了散射方向的概率分布
- **各向同性散射 (Isotropic-scattering, g=0)**: 光线会向所有方向均匀地散射，没有特定的方向偏好
- **前向散射 (Forward-scattering, g>0)**: 光线更倾向于继续沿着原来的方向前进，例如水中的微小粒子
- **后向散射 (Back-scattering, g<0)**: 光线更倾向于被反射回来的方向
![[13.高级光线传播-1755757895373.png]]
**体积路径追踪 (Volumetric Path Tracing)**
为了渲染参与介质，我们需要一种能够在体积内部模拟光线弹射的算法。体积路径追踪是一种常用的方法：
- 光线进入介质后，会向前行进一段**随机的距离**
- 在行进结束后到达的“着色点”处，光线会与介质发生一次交互，通常是**散射**
- 在散射点，算法会随机选择一个**新的弹射方向**（由相位函数决定）
- 同时，为了高效地计算直接光照，在每个散射点，我们都会尝试向光源**直接连接**一条光线（阴影连接），计算直接光照的贡献
- 光线继续沿着新方向前进，重复上述过程，直到离开介质或被完全吸收
这个过程本质上是将路径追踪从“在表面之间弹射”扩展到了“在**介质内部的散射点之间弹射**”

渲染方程只告诉我们**光线**与物体**表面**的作用，没告诉我们**光线**与**体积**如何作用。这方面的数学计算需要依靠其他的工具

### 毛发/毛皮/纤维（Translucent material
![[13.高级光线传播-1755758973909.png]]
渲染毛发是计算机图形学中最具挑战性的任务之一。这不仅因为场景中可能包含数十万到数百万根独立的纤维，还因为单根头发本身就是一个复杂的光学结构。光线与头发的交互不仅仅是表面反射，还包括折射进入发丝内部、在内部散射和吸收，并再次折射出来。因此，我们通常将其视为一种**半透明材质**，并使用专门的模型来描述

渲染毛发的核心问题是定义光线如何与一个圆柱体或曲线发生作用。早期的模型使用简化的几何和光照假设，而现代模型则更深入地模拟了头发的物理结构（表皮、皮质、髓质）
#### Kajiya-Kay模型
![[13.高级光线传播-1755759084789.png]]
这是最早也是最经典的毛发着色模型之一
**核心思想**: 将每根头发简化为一个同时具有**漫反射**和**镜面反射**特性的理想圆柱体
到达其上的光线会有两种反应：
- **1.被均匀反射**（镜面反射）：基于 phone 模型，模拟光线在头发圆柱体表面形成的**高光**，表现了头发的光泽感
- **2.朝圆锥形状的区域反射**（漫反射）:基于 **兰伯特模型(Lambertian Model)**，模拟光线射入头发后，被内部色素吸收部分颜色，然后向所有方向均匀散射出来的效果。这部分决定了头发的**基底色**
![[13.高级光线传播-1755760056149.png]]
#### Marschner模型
基于头发物理结构的、全面的光学模型。该模型至今仍是大多数现代电影和游戏中毛发渲染的基础
![[13.高级光线传播-1755760352141.png]]
**核心思想**: 该模型通过追踪光线在单根发丝（一个带有倾斜的角质层鳞片的透明圆柱体）内外经历的主要光路来模拟其外观。主要考虑了三种光路：
    1. **R**: 光线直接从发丝外表面**反射** (Reflection)。这是我们看到的主高光
    2. **TT**: 光线**折射** (Transmit) 进入发丝内部，在内部后壁发生一次**反射**，再**折射** (Transmit) 出来。这是第二个、颜色较饱和的高光，通常位于主高光下方并朝发根方向偏移
    3. **TRT**: 光线**折射** (Transmit) 进入内部，发生一次**反射**，再**折射**出去时在内壁发生**全内反射**，再次进入内部，最终**透射** (Transmit) 出来。这个路径的贡献相对较小，但会使毛发整体看起来更亮、更有体积感
![[13.高级光线传播-1755760447521.png]]
 **颜色**: 头发的颜色是在光线穿过发丝皮质(cortex)时，被内部的黑色素(melanin)吸收部分波长的光而产生的。因此，`TT` 和 `TRT` 路径产生的高光会带有头发的颜色
 ![[13.高级光线传播-1755760494967.png]]
与单根头发作用还不够，需要考虑头发和头发之间的作用，称作多次散射，计算量就很大了
#### 动物毛发模型
![[13.高级光线传播-1755760645176.png]]
研究人员（闫神）通过研究人类毛发和动物毛发的生物学特征，发现：
动物毛发中的最内层的**髓质**（Medulla）占比非常大，光线进去之后更容易发生散射
![[13.高级光线传播-1755760739648.png]]
逐渐增加髓质的比例，动物毛发的质感会发生明显的变化
![[13.高级光线传播-1755760791057.png]]
有髓质和无髓质的人类毛发渲染效果也差别很大
![[13.高级光线传播-1755760819529.png]]
#### 双层圆柱模型
![[13.高级光线传播-1755760873182.png]]
将单根毛发模拟为两个同心圆柱：一个外部的角质层（负责高光），以及一个内部的皮质/髓质圆柱（负责复杂的体积散射）
到达其上的光线会有以下几种反应：
1. 朝圆锥形状的区域反射（R）
2. 穿进头发内部穿过髓质 / 没打到髓质 - 再穿出头发（TT）
3. 穿进头发内部-被髓质散射（TTs）
4. 穿进头发内部-在毛发内壁发生反射往回走-穿出头发（TRT）
5. 穿进头发内部-在毛发髓质中发生两次散射-穿出头发（TRTs）
![[13.高级光线传播-1755760992412.png]]

### 颗粒材料
![[13.高级光线传播-1755761249643.png]]
一般用到的方案是：定义一堆颗粒中每种颗粒所占的比例，计算量非常大
![[13.高级光线传播-1755761320501.png|502x284]]
到目前为止，颗粒材质也没有得到比较好的解决
## 表面模型
这类模型处理的是发生在物体表面，但标准微表面BRDF难以描述的复杂光学现象
### 透光材料(BSSRDF)
透光Translucent：光线从某个位置进入物体，经过**一些作用**，再从另一个位置射出
（透光Translucent与半透明semi-transparent是有区别的）
![[13.高级光线传播-1755762167117.png]]
牛奶、人的皮肤等物体都会发生次表面散射
次表面散射可以看作是 BRDF 的一个延伸
- BRDF：光线打到了这个点，再从这个点反射。（全过程发生在一个点上）
- 次表面散射 BSSRDF：光线打到了这个点，但可以从其他点出去
![[13.高级光线传播-1755762347523.png]]
(从哪个点 $x_i$、哪个方向进来 $w_i$；从哪个点 $x_o$、哪个方向出去 $w_o$)

人们认为次表面散射现象可以等价于物体里面有一个光源在发光
![[13.高级光线传播-1755762515457.png]]
为了物理上的真实，给光源做**成对处理**，用此方法用来近似次表面散射的结果
![[13.高级光线传播-1755762590988.png|BRDF]]
![[13.高级光线传播-1755762621492.png|BSSRDF]]
![[13.高级光线传播-1755762717678.png]]
使用次表面散射可以得到非常真实的皮肤
### 布料
布料实际上是多根纤维多次缠绕形成的
纤维      ->       股      ->    线    ->     通过机器纺织或者手工编织
Fibers   ->      Ply    ->    Yarn   ->   通过机器纺织或者手工编织
![[13.高级光线传播-1755762949548.png]]
根据各种不同的编织方式可以统计上建模出BRDF模型
![[13.高级光线传播-1755763021979.png]]
有一些**立体面料**用BRDF明显无法很好地描述，比如天鹅绒
![[13.高级光线传播-1755763071347.png]]
所以更准确的方法是：把织物看作是**空间中分布的体积，即当作散射介质来渲染，但计算量也更大**
![[13.高级光线传播-1755763118472.png]]

或者，还可以像真实的纤维一样来渲染布料，每根纤维都算
![[13.高级光线传播-1755763149815.png]]


### 细节材料(非统计BRDF)
现今渲染器渲染出的物体有一个问题：过于完美
![[13.高级光线传播-1755763221986.png]]
真实的世界往往充满瑕疵和磨损
![[13.高级光线传播-1755763248906.png]]
细节模型可以带来更多真实感
![[13.高级光线传播-1755763305388.png]]
理论的法线分布很完美，实际上的法线分布会有扰动
![[13.高级光线传播-1755763344600.png]]
如果要求细节：物体法线分布基本符合物理规律，但会存在扰动
![[13.高级光线传播-1755763423076.png]]
（使用了200k\*200k 的法线贴图，渲染时间很长）
耗时长的原因：路径难以采样
- 考虑一个针孔摄像机和一个点光源
- 认为**每个微表面是一个镜面**，镜面反射方向确定。
- 此时就**很难让针孔摄像机发出的光线反射到光源**，光源发出的光线同时难以到达摄像机
![[13.高级光线传播-1755763692352.png]]

改进：
- 考虑**一个像素覆盖多个微表面**
- 把这个区域的微表面法线分布，替代原本光滑的分布
![[13.高级光线传播-1755764636253.png]]
选取不同范围的微表面，显示的法线分布的特点不同
![[13.高级光线传播-1755764673894.png]]
选取不同形状特点的微表面，显示的法线分布的特点也不同
![[13.高级光线传播-1755764731675.png]]

## 波动光学
其实当物体非常小的时候，用几何光学就不完全正确了，就需要考虑衍射和干涉现象，那么就会涉及到波动光学

**波动光学**将光视为电磁波，是更底层的物理模型。薄膜干涉和衍射等现象，只有在波动光学的框架下才能得到最根本的物理解释。在图形学中进行完整的波动光学模拟非常复杂且计算昂贵，通常只在需要极致物理精度的科学可视化或离线渲染中进行尝试
## 程序化外观
![[13.高级光线传播-1755764943771.png]]
这是一种与传统手绘或扫描贴图相对的材质生成方法
- **核心思想**: 不使用静态的位图纹理，而是通过**数学算法和噪声函数**（如Perlin噪声、分形等）来实时**生成**材质的各种属性（颜色、粗糙度、法线等）
- **优点**:
    - **分辨率无关**: 可以无限放大而不会出现像素化
    - **占用空间小**: 只需要存储算法和参数，而非庞大的纹理文件
    - **灵活性和可控性**: 调整参数即可轻松创造出无穷无尽的变化，并易于制作动画效果
- **应用**: 创建各种复杂的、非重复的自然或抽象外观，如**木纹、大理石纹理、锈迹、程序化地形**等

